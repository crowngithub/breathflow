<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>息道 - 丹田呼吸 AI 训练器</title>
    <!-- PWA 适配 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="息道">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#010204">

    <!-- 基础依赖库 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#010204] m-0 p-0 overflow-hidden text-slate-200 font-sans antialiased">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // 应用版本 v1.13.1 - 找回亮屏选项，完善运行策略
        const APP_VERSION = "1.13.1";
        const DEFAULT_BASE_URL = "https://generativelanguage.googleapis.com";

        const Icon = ({ name, size = 24, className = "" }) => {
            const icons = {
                Play: <path d="m5 3 14 9-14 9V3z"/>,
                Pause: <><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></>,
                RotateCcw: <><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></>,
                Settings: <><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></>,
                Volume2: <><path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></>,
                VolumeX: <><path d="M11 5L6 9H2v6h4l5 4V5z"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/></>,
                Plus: <path d="M12 5v14M5 12h14" />,
                Minus: <path d="M5 12h14" />,
                Clock: <><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>,
                Bell: <><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></>,
                Waves: <><path d="M2 6c.6.5 1.2 1 2.5 1s2.5-1 4-1 2.6 1 4 1 2.5-1 4-1 2.5 1 4 1"/><path d="M2 12c.6.5 1.2 1 2.5 1s2.5-1 4-1 2.6 1 4 1 2.5-1 4-1 2.5 1 4 1"/><path d="M2 18c.6.5 1.2 1 2.5 1s2.5-1 4-1 2.6 1 4 1 2.5-1 4-1 2.5 1 4 1"/></>,
                CloudRain: <path d="M20 16.2A4.5 4.5 0 0 0 17.5 8h-1.8A7 7 0 1 0 4 14.9M12 18v4M8 18v2M16 18v2"/>,
                Wind: <path d="M17.7 7.7a2.5 2.5 0 1 1 1.8 4.3H2M9.6 4.6A2 2 0 1 1 11 8H2M12.6 19.4A2 2 0 1 0 14 16H2" />,
                Ban: <><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></>,
                Sparkles: <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/>,
                Info: <><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></>,
                RotateCw: <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/>,
                CheckCircle: <><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>,
                Zap: <path d="M13 2 L3 14 L12 14 L11 22 L21 10 L12 10 L13 2 Z"/>,
                Shield: <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || <circle cx="12" cy="12" r="10" />}
                </svg>
            );
        };

        const easeInOutSine = (x) => -(Math.cos(Math.PI * x) - 1) / 2;

        const App = () => {
            const [isActive, setIsActive] = useState(false);
            const [phase, setPhase] = useState('ready'); 
            const [settings, setSettings] = useState({
                inhale: 4, hold: 0, exhale: 4,
                volume: 0.4, 
                transitionSound: 'qing',    
                bgType: 'none',             
                sessionDuration: 20,        
                runMode: 'background',      // 默认运行模式：锁屏存活
                apiProxyUrl: DEFAULT_BASE_URL
            });
            const [elapsedTime, setElapsedTime] = useState(0);
            const [displayProgress, setDisplayProgress] = useState(0); 
            const [showSettings, setShowSettings] = useState(false);
            const [showInfo, setShowInfo] = useState(false);
            const [showAI, setShowAI] = useState(false);
            const [userMood, setUserMood] = useState("");
            const [isAIThinking, setIsAIThinking] = useState(false);
            const [aiSuggestion, setAiSuggestion] = useState(null);
            const [updateToast, setUpdateToast] = useState(false);

            const audioCtxRef = useRef(null);
            const whiteGainRef = useRef(null); 
            const brownGainRef = useRef(null); 
            const bgFilterRef = useRef(null);
            const modGainRef = useRef(null);
            const animationFrameRef = useRef(null);
            const wakeLockRef = useRef(null); // 亮屏锁引用
            const lastPhaseRef = useRef('ready');
            const cycleStartTimeRef = useRef(0);
            const apiKey = ""; 

            const isActiveRef = useRef(isActive);
            useEffect(() => { isActiveRef.current = isActive; }, [isActive]);

            // PWA 与版本管理
            useEffect(() => {
                const lastVersion = localStorage.getItem('breathflow_version');
                if (lastVersion && lastVersion !== APP_VERSION) {
                    setUpdateToast(true);
                    setTimeout(() => setUpdateToast(false), 5000);
                }
                localStorage.setItem('breathflow_version', APP_VERSION);
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('./sw.js').catch(() => {});
                }
            }, []);

            // --- 常亮锁 (Wake Lock) 逻辑 ---
            const requestWakeLock = async () => {
                if ('wakeLock' in navigator && settings.runMode === 'wakelock') {
                    try {
                        wakeLockRef.current = await navigator.wakeLock.request('screen');
                    } catch (err) {
                        console.warn('Wake Lock request failed:', err);
                    }
                }
            };

            const releaseWakeLock = () => {
                if (wakeLockRef.current) {
                    wakeLockRef.current.release().then(() => {
                        wakeLockRef.current = null;
                    });
                }
            };

            useEffect(() => {
                if (isActive && settings.runMode === 'wakelock') {
                    requestWakeLock();
                } else {
                    releaseWakeLock();
                }
                return () => releaseWakeLock();
            }, [isActive, settings.runMode]);

            const forceFullReload = async () => {
                try {
                    if ('serviceWorker' in navigator) {
                        const regs = await navigator.serviceWorker.getRegistrations();
                        for (let reg of regs) await reg.unregister();
                    }
                    if ('caches' in window) {
                        const keys = await caches.keys();
                        for (let key of keys) await caches.delete(key);
                    }
                    localStorage.removeItem('breathflow_version');
                    window.location.href = window.location.origin + window.location.pathname + '?sync=' + Date.now();
                } catch (e) { window.location.reload(true); }
            };

            // --- 实时音效播放 ---
            const playTone = useCallback(() => {
                if (settings.transitionSound === 'none' || !audioCtxRef.current) return;
                const ctx = audioCtxRef.current;
                const now = ctx.currentTime;
                const vol = settings.volume;

                const createOsc = (freq, dur, reso = false) => {
                    const osc = ctx.createOscillator(); const gain = ctx.createGain();
                    osc.type = 'sine'; osc.frequency.setValueAtTime(freq, now);
                    if (reso) osc.frequency.exponentialRampToValueAtTime(freq * 0.98, now + dur);
                    gain.gain.setValueAtTime(0, now);
                    gain.gain.linearRampToValueAtTime(vol * 0.5, now + 0.005);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + dur);
                    osc.connect(gain); gain.connect(ctx.destination);
                    osc.start(now); osc.stop(now + dur);
                };

                if (settings.transitionSound === 'qing') createOsc(220, 2.0, true);
                else if (settings.transitionSound === 'muyu') createOsc(750, 0.12);
                else if (settings.transitionSound === 'drop') {
                    const o = ctx.createOscillator(); const g = ctx.createGain();
                    o.frequency.setValueAtTime(800, now);
                    o.frequency.exponentialRampToValueAtTime(1600, now + 0.05);
                    o.frequency.exponentialRampToValueAtTime(400, now + 0.15);
                    g.gain.setValueAtTime(0, now); g.gain.linearRampToValueAtTime(vol * 0.3, now + 0.002);
                    g.gain.exponentialRampToValueAtTime(0.001, now + 0.2);
                    o.connect(g); g.connect(ctx.destination);
                    o.start(now); o.stop(now + 0.2);
                }
            }, [settings.transitionSound, settings.volume]);

            const handleStartSession = async () => {
                if (isActive) {
                    setIsActive(false);
                    return;
                }

                if (!audioCtxRef.current) {
                    try {
                        const ctx = new (window.AudioContext || window.webkitAudioContext)();
                        audioCtxRef.current = ctx;
                        
                        const bufferSize = 2 * ctx.sampleRate;
                        const whiteBuffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
                        const brownBuffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
                        const wD = whiteBuffer.getChannelData(0); const bD = brownBuffer.getChannelData(0);
                        let lastOut = 0;
                        for (let i = 0; i < bufferSize; i++) {
                            wD[i] = Math.random() * 2 - 1;
                            const white = Math.random() * 2 - 1;
                            bD[i] = (lastOut + (0.02 * white)) / 1.002; lastOut = bD[i]; bD[i] *= 3.5;
                        }
                        const wSrc = ctx.createBufferSource(); wSrc.buffer = whiteBuffer; wSrc.loop = true;
                        const bSrc = ctx.createBufferSource(); bSrc.buffer = brownBuffer; bSrc.loop = true;
                        
                        const filter = ctx.createBiquadFilter(); filter.type = 'lowpass';
                        const wGain = ctx.createGain(); const bGain = ctx.createGain();
                        const modGain = ctx.createGain();
                        wGain.gain.value = 0; bGain.gain.value = 0;
                        
                        wSrc.connect(wGain); bSrc.connect(bGain);
                        wGain.connect(modGain); bGain.connect(modGain);
                        modGain.connect(filter); filter.connect(ctx.destination);
                        
                        wSrc.start(); bSrc.start();
                        whiteGainRef.current = wGain; brownGainRef.current = bGain;
                        bgFilterRef.current = filter; modGainRef.current = modGain;
                    } catch (e) { console.error(e); }
                } else if (audioCtxRef.current.state === 'suspended') {
                    audioCtxRef.current.resume();
                }

                setIsActive(true);
                cycleStartTimeRef.current = performance.now();
                setElapsedTime(0);
            };

            // --- 渲染与音频参数 ---
            useEffect(() => {
                if (!isActive) {
                    const now = audioCtxRef.current?.currentTime || 0;
                    if (whiteGainRef.current) whiteGainRef.current.gain.setTargetAtTime(0, now, 0.1);
                    if (brownGainRef.current) brownGainRef.current.gain.setTargetAtTime(0, now, 0.1);
                    return;
                }

                const animate = (time) => {
                    if (!isActiveRef.current) return;
                    const totalSec = settings.inhale + settings.hold + settings.exhale;
                    const elapsedMs = time - cycleStartTimeRef.current;
                    const elapsedInCycle = (elapsedMs / 1000) % totalSec;
                    
                    let cPh = 'inhale', cPr = 0;
                    const i = settings.inhale, h = settings.hold, e = settings.exhale;
                    if (elapsedInCycle < i) { cPh = 'inhale'; cPr = elapsedInCycle / i; }
                    else if (elapsedInCycle < i + h) { cPh = 'hold'; cPr = (elapsedInCycle - i) / h; }
                    else { cPh = 'exhale'; cPr = (elapsedInCycle - i - h) / e; }
                    
                    if (cPh !== lastPhaseRef.current) {
                        playTone();
                        lastPhaseRef.current = cPh;
                    }

                    setPhase(cPh); setDisplayProgress(Math.min(cPr, 1));

                    const ctx = audioCtxRef.current;
                    if (ctx) {
                        const now = ctx.currentTime;
                        let wG = 0, bG = 0, freq = 600, mG = 1.0;
                        switch(settings.bgType) {
                            case 'rain': wG = settings.volume * 0.35; bG = settings.volume * 0.1; freq = 1500; mG = 0.8 + Math.random() * 0.4; break;
                            case 'wind': bG = settings.volume * 0.5 * (0.9 + Math.sin(now * 0.3) * 0.1); freq = 300 + Math.sin(now * 0.2) * 100; break;
                            case 'white': wG = settings.volume * 0.25; freq = 1800; break;
                        }
                        if (whiteGainRef.current) whiteGainRef.current.gain.setTargetAtTime(wG, now, 0.5);
                        if (brownGainRef.current) brownGainRef.current.gain.setTargetAtTime(bG, now, 0.5);
                        if (bgFilterRef.current) bgFilterRef.current.frequency.setTargetAtTime(freq, now, 0.5);
                        if (modGainRef.current) modGainRef.current.gain.setTargetAtTime(mG, now, 0.05);
                    }

                    animationFrameRef.current = requestAnimationFrame(animate);
                };
                animationFrameRef.current = requestAnimationFrame(animate);
                return () => cancelAnimationFrame(animationFrameRef.current);
            }, [isActive, settings.inhale, settings.hold, settings.exhale, settings.bgType, settings.volume, playTone]);

            useEffect(() => {
                let t;
                if (isActive) {
                    t = setInterval(() => {
                        setElapsedTime(p => {
                            const next = p + 1;
                            if (next >= settings.sessionDuration * 60) {
                                setIsActive(false); 
                                return next;
                            }
                            return next;
                        });
                    }, 1000);
                }
                return () => clearInterval(t);
            }, [isActive, settings.sessionDuration]);

            const callGemini = async (prompt, sys) => {
                let delay = 1000;
                const url = `${settings.apiProxyUrl}/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                for (let i = 0; i < 5; i++) {
                    try {
                        const res = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], systemInstruction: { parts: [{ text: sys }] }, generationConfig: { responseMimeType: "application/json" } }) });
                        const data = await res.json();
                        return JSON.parse(data.candidates[0].content.parts[0].text);
                    } catch (err) { if (i === 4) throw err; await new Promise(r => setTimeout(r, delay)); delay *= 2; }
                }
            };

            const generateAISuggestion = async () => {
                if (!userMood) return;
                setIsAIThinking(true);
                try {
                    const res = await callGemini(`当前感受: ${userMood}`, "你是一位禅修大师。建议呼吸参数 JSON: { inhale:数字, hold:数字, exhale:数字, wisdom:短引导语 }。建议时长3-12秒。");
                    setAiSuggestion(res);
                } catch (e) { console.error(e); } finally { setIsAIThinking(false); }
            };

            const adjustAll = (d) => {
                setSettings(s => ({...s, inhale: Math.max(1, s.inhale + d), exhale: Math.max(1, s.exhale + d)}));
            };

            const { scale, color, opacity } = (() => {
                const sP = easeInOutSine(displayProgress);
                let s = 1, c = 'rgb(59, 130, 246)', o = 0.1;
                if (phase === 'inhale') { s = 1 + sP * 0.85; c = 'rgb(59, 130, 246)'; o = 0.1 + sP * 0.4; }
                else if (phase === 'hold') { s = 1.85; c = 'rgb(52, 211, 153)'; o = 0.5; }
                else if (phase === 'exhale') { s = 1.85 - sP * 0.85; c = 'rgb(244, 63, 94)'; o = 0.5 - sP * 0.4; }
                return { scale: s, color: c, opacity: o };
            })();

            return (
                <div className="min-h-screen bg-[#010204] text-slate-200 flex flex-col items-center justify-between p-6 overflow-hidden select-none font-sans antialiased">
                    
                    {updateToast && (
                        <div className="fixed top-12 left-1/2 -translate-x-1/2 z-[200] bg-blue-600 text-white px-6 py-3 rounded-2xl shadow-2xl flex items-center gap-3 animate-in fade-in slide-in-from-top-4 duration-500">
                           <Icon name="CheckCircle" size={18} />
                           <div className="flex flex-col text-left">
                              <span className="text-sm font-bold tracking-wide">版本已就绪 v{APP_VERSION}</span>
                              <span className="text-[10px] opacity-80">亮屏与保活功能已恢复</span>
                           </div>
                        </div>
                    )}

                    {/* Header */}
                    <div className="w-full max-w-lg flex justify-between items-center z-20 pt-10 px-4">
                        <div className="flex flex-col">
                            <h1 className="text-2xl font-extralight tracking-[0.4em] text-white">息道</h1>
                            <div className="flex items-center gap-2 mt-1">
                                <div className={`w-1.5 h-1.5 rounded-full ${isActive ? 'bg-green-500 animate-pulse' : 'bg-slate-600'}`}></div>
                                <span className="text-[10px] text-slate-500 tracking-widest uppercase font-medium">Professional Session</span>
                            </div>
                        </div>
                        <div className="flex items-center gap-3">
                            <button onClick={() => setShowAI(true)} className="p-3 bg-blue-600/20 border border-blue-500/30 rounded-2xl text-blue-400 active:scale-95 shadow-lg"><Icon name="Sparkles" size={20}/></button>
                            <button onClick={() => setShowInfo(true)} className="p-3 bg-white/5 rounded-2xl text-slate-400 active:scale-95 shadow-lg"><Icon name="Info" size={20}/></button>
                            <button onClick={() => setShowSettings(true)} className="p-3 bg-white/5 rounded-2xl text-slate-400 active:scale-95 shadow-lg"><Icon name="Settings" size={20}/></button>
                        </div>
                    </div>

                    {/* Main UI Area */}
                    <div className="relative flex flex-col items-center justify-center flex-1 w-full scale-90 md:scale-100">
                        {isActive && (
                            <div className="absolute top-0 flex items-center gap-2 bg-blue-500/10 px-4 py-2 rounded-xl text-[9px] text-blue-400/80 tracking-widest uppercase animate-pulse z-30">
                                <Icon name={settings.runMode === 'wakelock' ? "Zap" : "Shield"} size={10} />
                                {settings.runMode === 'wakelock' ? "亮屏锁定：常亮" : "后台存活：不休眠"}
                            </div>
                        )}
                        <div className="absolute w-[500px] h-[500px] rounded-full blur-[100px] transition-all duration-1000" style={{ backgroundColor: color, opacity: opacity * 0.3 }}></div>
                        <div className="relative" style={{ transform: `scale(${scale})`, transition: 'transform 0.1s linear' }}>
                            <div className="w-48 h-48 md:w-64 md:h-64 rounded-full border-[1.5px] flex items-center justify-center bg-black/40 backdrop-blur-md transition-colors duration-1000 shadow-2xl" style={{ borderColor: `${color}${isActive ? '' : '33'}` }}>
                                <span className="text-4xl font-extralight tracking-[0.6em] transition-all duration-1000 ml-3" style={{ color: color, opacity: isActive ? 1 : 0.3 }}>
                                    {phase === 'ready' ? '静' : phase === 'inhale' ? '吸' : phase === 'hold' ? '止' : '呼'}
                                </span>
                            </div>
                        </div>
                        
                        <div className="mt-16 flex flex-col items-center gap-6 z-10 w-full">
                           <div className="flex items-center gap-8 bg-white/[0.03] p-1.5 px-4 rounded-full border border-white/5 backdrop-blur-sm shadow-inner transition-all hover:bg-white/5">
                             <button onClick={() => adjustAll(-1)} className="p-2 text-slate-500 active:scale-75"><Icon name="Minus" size={20} /></button>
                             <div className="flex flex-col items-center min-w-[100px]">
                               <span className="text-[10px] uppercase tracking-widest text-slate-600 mb-0.5 font-bold">呼吸步长</span>
                               <span className="text-lg font-light tabular-nums text-blue-400">{settings.inhale}s <span className="text-slate-600">/</span> {settings.exhale}s</span>
                             </div>
                             <button onClick={() => adjustAll(1)} className="p-2 text-slate-500 active:scale-75"><Icon name="Plus" size={20} /></button>
                           </div>
                           <div className="text-center px-4 max-w-xs text-slate-500 text-[10px] tracking-[0.3em] uppercase leading-relaxed h-8">
                             {phase === 'ready' ? (aiSuggestion ? aiSuggestion.wisdom : "神定丹田，意随息转") : `训练中 - 剩余 ${Math.max(0, settings.sessionDuration * 60 - elapsedTime)}秒`}
                           </div>
                        </div>
                    </div>

                    {/* 音量滑块与主控 */}
                    <div className="w-full max-w-md space-y-6 z-20 mb-6 px-6">
                        <div className="flex flex-col gap-2">
                           <div className="flex justify-between items-center px-2">
                              <span className="text-[9px] text-slate-600 uppercase tracking-widest font-bold">Master Volume</span>
                              <span className="font-mono text-[9px] text-slate-500 tabular-nums">{Math.round(settings.volume * 100)}%</span>
                           </div>
                           <div className="flex items-center gap-4">
                            <Icon name={settings.volume > 0 ? "Volume2" : "VolumeX"} size={16} className="text-slate-600" />
                            <input type="range" min="0" max="1" step="0.01" value={settings.volume} onChange={(e) => setSettings(s => ({...s, volume: parseFloat(e.target.value)}))} className="w-full h-[3px] bg-white/10 rounded-full appearance-none accent-blue-500 shadow-inner" style={{ background: `linear-gradient(to right, #3b82f6 ${settings.volume * 100}%, rgba(255,255,255,0.1) ${settings.volume * 100}%)` }} />
                           </div>
                        </div>

                        <div className="bg-white/[0.03] backdrop-blur-2xl border border-white/10 rounded-[2.5rem] p-4 flex items-center justify-around shadow-2xl">
                            <button onClick={() => { setIsActive(false); setElapsedTime(0); setPhase('ready'); setDisplayProgress(0); }} className="p-4 rounded-full bg-white/5 text-slate-500 active:scale-90"><Icon name="RotateCcw" size={22} /></button>
                            <button onClick={handleStartSession} className={`p-8 rounded-full transition-all active:scale-95 shadow-2xl relative ${isActive ? 'bg-white text-black' : 'bg-blue-600 text-white shadow-blue-600/30'}`}>
                                <Icon name={isActive ? "Pause" : "Play"} size={32} className={isActive ? "" : "ml-1"} />
                                {!isActive && <div className="absolute inset-0 rounded-full border border-blue-400 animate-ping opacity-20"></div>}
                            </button>
                            <div className="flex items-center gap-2 bg-white/5 px-4 py-2 rounded-full border border-white/10">
                                <Icon name="Clock" size={12} className="text-slate-500" />
                                <span className="font-mono text-xs tabular-nums">{Math.floor(elapsedTime / 60).toString().padStart(2, '0')}:{(elapsedTime % 60).toString().padStart(2, '0')}</span>
                            </div>
                        </div>
                    </div>

                    {/* 设置弹窗 */}
                    {showSettings && (
                        <div className="fixed inset-0 bg-black/95 backdrop-blur-xl z-[100] flex items-center justify-center p-6 animate-in">
                            <div className="bg-slate-900/90 w-full max-w-sm rounded-[2.5rem] border border-white/10 p-8 space-y-6 shadow-2xl overflow-y-auto max-h-[90vh]">
                                <div className="flex justify-between items-center mb-4 sticky top-0 bg-transparent z-10">
                                    <h3 className="text-sm font-medium tracking-widest uppercase text-white">专业配置</h3>
                                    <button onClick={() => setShowSettings(false)} className="text-[10px] bg-blue-600 px-4 py-2 rounded-full uppercase text-white font-bold shadow-lg shadow-blue-600/20">确认</button>
                                </div>
                                
                                <div className="space-y-4 p-4 bg-white/5 rounded-2xl border border-white/5">
                                    <label className="text-[10px] text-slate-400 uppercase tracking-widest">系统策略</label>
                                    <div className="grid grid-cols-2 gap-2 mt-2">
                                        {[
                                            { id: 'background', label: '锁屏存活', icon: 'Shield' },
                                            { id: 'wakelock', label: '屏幕常亮', icon: 'Zap' }
                                        ].map(o => (
                                            <button key={o.id} onClick={() => setSettings(s => ({...s, runMode: o.id}))} className={`flex flex-col items-center gap-2 p-3 rounded-xl border transition-all ${settings.runMode === o.id ? 'bg-blue-600/20 border-blue-500 text-blue-400' : 'bg-white/5 border-white/5 text-slate-500'}`}>
                                                <Icon name={o.icon} size={16} /> <span className="text-[9px]">{o.label}</span>
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                <div className="space-y-4 p-4 bg-white/5 rounded-2xl border border-white/5">
                                    <label className="text-[10px] text-slate-400 uppercase tracking-widest">单次练习时长</label>
                                    <div className="grid grid-cols-5 gap-1.5 mt-2">
                                        {[10, 20, 30, 45, 60].map(mins => (
                                            <button key={mins} onClick={() => setSettings(s => ({...s, sessionDuration: mins}))} className={`py-2 rounded-lg text-[10px] font-mono border transition-all ${settings.sessionDuration === mins ? 'bg-blue-600 border-blue-500 text-white' : 'bg-white/5 border-white/5 text-slate-500'}`}>
                                                {mins}m
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                <div className="space-y-2 pt-4 border-t border-white/5">
                                    <label className="text-[10px] text-slate-500 uppercase tracking-widest">仿真环境声音</label>
                                    <div className="grid grid-cols-2 gap-2 mt-2">
                                        {[ 
                                            { id: 'none', label: '无背景音', icon: 'Ban' }, 
                                            { id: 'rain', label: '自然雨声', icon: 'CloudRain' }, 
                                            { id: 'wind', label: '空灵风声', icon: 'Wind' },
                                            { id: 'white', label: '柔和噪音', icon: 'Waves' } 
                                        ].map(o => (
                                            <button key={o.id} onClick={() => setSettings(s => ({...s, bgType: o.id}))} className={`flex flex-col items-center gap-2 p-3 rounded-xl border transition-all ${settings.bgType === o.id ? 'bg-blue-600/20 border-blue-500 text-blue-400' : 'bg-white/5 border-white/5 text-slate-500'}`}>
                                                <Icon name={o.icon} size={16} /> <span className="text-[9px]">{o.label}</span>
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                <div className="space-y-2 pt-4 border-t border-white/5">
                                    <label className="text-[10px] text-slate-500 uppercase tracking-widest">转折音效选择</label>
                                    <div className="grid grid-cols-2 gap-2 mt-2">
                                        {[ { id: 'qing', label: '静心颂钵', icon: 'Bell' }, { id: 'muyu', label: '禅意木鱼', icon: 'Drum' }, { id: 'drop', label: '灵动水滴', icon: 'Droplets' }, { id: 'none', label: '无音效', icon: 'Ban' } ].map(o => (
                                            <button key={o.id} onClick={() => setSettings(s => ({...s, transitionSound: o.id}))} className={`flex flex-col items-center gap-2 p-3 rounded-xl border transition-all ${settings.transitionSound === o.id ? 'bg-blue-600/20 border-blue-500 text-blue-400' : 'bg-white/5 border-white/5 text-slate-500'}`}>
                                                <Icon name={o.icon} size={16} /> <span className="text-[9px]">{o.label}</span>
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                <div className="space-y-4 pt-4 border-t border-white/5">
                                    {[{ label: '吸气 Inhale', key: 'inhale' }, { label: '屏息 Hold', key: 'hold' }, { label: '呼气 Exhale', key: 'exhale' }].map(item => (
                                        <div key={item.key} className="flex items-center justify-between">
                                            <label className="text-[10px] text-slate-400 uppercase tracking-widest">{item.label}</label>
                                            <div className="flex items-center gap-3">
                                                <button onClick={() => setSettings(s => ({...s, [item.key]: Math.max(0.5, s[item.key] - 0.5)}))} className="p-1.5 rounded-lg bg-white/5 text-slate-400 hover:text-white transition-all"><Icon name="Minus" size={12}/></button>
                                                <span className="w-8 text-center text-lg font-light tabular-nums text-white">{settings[item.key]}</span>
                                                <button onClick={() => setSettings(s => ({...s, [item.key]: s[item.key] + 0.5}))} className="p-1.5 rounded-lg bg-white/5 text-slate-400 hover:text-white transition-all"><Icon name="Plus" size={12}/></button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                
                                <div className="pt-8 border-t border-white/5 flex flex-col items-center gap-2 text-slate-600">
                                    <span className="text-[9px] uppercase tracking-tighter">BreathFlow v{APP_VERSION}</span>
                                    <button onClick={forceFullReload} className="mt-2 flex items-center gap-2 px-4 py-2 rounded-xl bg-red-600/10 text-red-500 text-[10px] uppercase tracking-widest active:scale-95 border border-red-500/20 transition-all">
                                        <Icon name="RotateCw" size={12} /> 强制同步重载
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 信息须知弹窗 */}
                    {showInfo && (
                        <div className="fixed inset-0 bg-black/95 backdrop-blur-xl z-[200] flex items-center justify-center p-6 animate-in">
                            <div className="bg-slate-900/90 w-full max-w-sm rounded-[2.5rem] border border-white/10 p-8 space-y-6 shadow-2xl overflow-y-auto max-h-[90vh]">
                                <div className="flex justify-between items-center mb-2">
                                    <h3 className="text-sm font-medium tracking-widest uppercase text-white">使用指南</h3>
                                    <button onClick={() => setShowInfo(false)} className="text-[10px] text-slate-500 uppercase">关闭</button>
                                </div>
                                <div className="space-y-4 text-slate-300 text-xs leading-relaxed">
                                    <p><span className="text-blue-400 font-bold">1. 亮屏/锁屏说明：</span>您可以选择“屏幕常亮”模式防止手机进入黑屏；或使用“锁屏存活”模式（由于系统限制，网页版在锁屏后发声可能不稳定，建议将应用“添加到主屏幕”后运行）。</p>
                                    <p><span className="text-blue-400 font-bold">2. 背景音与时长：</span>已恢复仿真雨声、风声等，且音量恒定。您可以设定 10-60 分钟练习时长。</p>
                                    <p><span className="text-blue-400 font-bold">3. 物理静音键：</span>iPhone 用户请务必确认左侧静音键已关闭，否则无法输出声音。</p>
                                </div>
                                <button onClick={() => setShowInfo(false)} className="w-full bg-blue-600 text-white rounded-2xl py-4 text-xs font-bold uppercase tracking-widest active:scale-95 transition-all">我已了解</button>
                            </div>
                        </div>
                    )}

                    {/* AI 智引弹窗 */}
                    {showAI && (
                        <div className="fixed inset-0 bg-black/95 backdrop-blur-xl z-[110] flex items-center justify-center p-6 animate-in">
                            <div className="bg-slate-900/90 w-full max-w-sm rounded-[2.5rem] border border-white/10 p-8 space-y-6 shadow-2xl">
                                <div className="flex justify-between items-center mb-2">
                                    <div className="flex items-center gap-2"><Icon name="Sparkles" size={16} className="text-blue-400" /><h3 className="text-sm font-medium tracking-widest uppercase text-white">AI 智引</h3></div>
                                    <button onClick={() => setShowAI(false)} className="text-[10px] text-slate-500 uppercase">关闭</button>
                                </div>
                                <div className="space-y-4">
                                    <textarea value={userMood} onChange={(e) => setUserMood(e.target.value)} placeholder="描述您的状态..." className="w-full bg-white/5 border border-white/10 rounded-2xl p-4 text-sm font-light h-24 outline-none focus:border-blue-500/50 transition-all text-white placeholder:text-slate-600" />
                                    <button onClick={generateAISuggestion} disabled={isAIThinking || !userMood} className="w-full bg-blue-600 text-white rounded-2xl py-4 text-xs font-bold uppercase tracking-widest shadow-lg active:scale-95 disabled:opacity-50 transition-all flex items-center justify-center gap-2">
                                        {isAIThinking ? <div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div> : "✨ 开启智引"}
                                    </button>
                                </div>
                                {aiSuggestion && (
                                    <div className="pt-6 border-t border-white/5 space-y-4">
                                        <div className="bg-blue-600/10 border border-blue-500/20 p-4 rounded-2xl">
                                            <p className="text-[10px] text-blue-400 uppercase mb-1 font-bold">建议频率</p>
                                            <p className="text-base font-light tabular-nums">吸 {aiSuggestion.inhale}s / 屏 {aiSuggestion.hold}s / 呼 {aiSuggestion.exhale}s</p>
                                        </div>
                                        <button onClick={() => { setSettings(p => ({...p, inhale: aiSuggestion.inhale, hold: aiSuggestion.hold, exhale: aiSuggestion.exhale})); setShowAI(false); }} className="w-full bg-white text-black rounded-2xl py-4 text-xs font-bold uppercase tracking-widest">同步至训练</button>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    <style>{`
                        input[type='range']::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #ffffff; box-shadow: 0 0 10px rgba(59, 130, 246, 0.5); cursor: pointer; border: 2px solid #3b82f6; }
                        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
                        .animate-in { animation: fadeIn 0.3s ease-out forwards; }
                    `}</style>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
